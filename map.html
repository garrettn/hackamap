<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Google Map Template with Geocoded Address</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/foundation/6.2.4/foundation.min.css">
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyB8KCqVcp520DoGnUy1xfzK3c7pEJ8xDNQ&libraries=visualization"></script>	<!-- Google Maps API -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <script>
	var customers;
    $.getJSON("customers2.json", function (json) {
        customers = json;
        Init();
    });
	var heatmapData = [];
	var coded = [];
	var failures = [];
	var map;	// Google map object
	var loadedCustomers = 0;
	var showHeatMap = false;
	var filterApplied = null;
	var geocoder = new google.maps.Geocoder();
	var points = [];

	var heatmap = null;

	// Initialize and display a google map
	function Init()
	{
		// Create a Google coordinate object for where to initially center the map
		var latlng = new google.maps.LatLng( 37.785, -122.435 );	// Washington, DC

		// Map options for how to display the Google map
		var mapOptions = { zoom: 12, center: latlng, mapTypeId: 'satellite'};

		// Show the Google map in the div with the attribute id 'map-canvas'.
		map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
		heatmap = new google.maps.visualization.HeatmapLayer({
          map: map
		});
		map.addListener('zoom_changed', modifiedZoom);
		load();
	}

	function modifiedZoom()
	{
        // @TODO Drew ... We broke the bounds call on line 55 :( but we can totally filter stuff bruh!
		var bounds = map.getBounds();
		var markerCount = 0;
		for(var i = 0; i < points.length; i++)
		{
			if(bounds.contains(points[i].marker.position))
			{
				markerCount++;
			}
		}
		if(markerCount > 50 && showHeatMap == false)
		{
			heatmap.setMap(map);
			unshowAllMarkers();
			showHeatMap = true;
		}
		else if(markerCount < 50 && showHeatMap == true)
		{
			showHeatMap = false;
			heatmap.setMap(null);
			showAllPoints();
			if(filterApplied!=null)
			{
				filterMap(filterApplied);
			}
		}
	}

	function load()
	{
		var arrayLength = customers.length;
		for (var i = 0; i < arrayLength; i++) {
            var lat = customers[i].lat
            var lng = customers[i].lng

            ShowLocation(new google.maps.LatLng(lat,lng), customers[i]);
            heatmapData.push(new google.maps.LatLng(lat,lng));
		}

        makeHeatMap();
        setTimeout(modifiedZoom,3000);
	}

	function makeHeatMap()
	{
		heatmap.setData(heatmapData)
		heatmap.setMap(map);
	}


//	// Update the Google map for the user's inputted address
//	function UpdateMap( )
//	{
//	        // instantiate a geocoder object
//
//		// Get the user's inputted address
//		var address = document.getElementById( "address" ).value;
//
//		// Make asynchronous call to Google geocoding API
//		geocoder.geocode( { 'address': address }, function(results, status) {
//			var addr_type = results[0].types[0];	// type of address inputted that was geocoded
//			if ( status == google.maps.GeocoderStatus.OK )
//				ShowLocation( results[0].geometry.location, address, addr_type );
//			else
//				alert("Geocode was not successful for the following reason: " + status);
//		});
//	}

	// Show the location (address) on the map.
	function ShowLocation( latlng, customer, address, addr_type)
	{
		loadedCustomers++;
		// Center the map at the specified location
		map.setCenter( latlng );

		// Set the zoom level according to the address level of detail the user specified
		//var zoom = 15;
//		switch ( addr_type )
//		{
//			case "administrative_area_level_1"	: zoom = 6; break;		// user specified a state
//			case "locality"						: zoom = 10; break;		// user specified a city/town
//			case "street_address"				: zoom = 15; break;		// user specified a street address
//		}
		//map.setZoom( zoom );

		// Place a Google Marker at the same location as the map center
		// When you hover over the marker, it will display the title
		var marker = new google.maps.Marker( {
			position: latlng,
			map: map,
			title: customer.name
		});
		points.push({"marker":marker,"customer":customer, "location":latlng, "shown": true});

		// Create an InfoWindow for the marker
		var contentString = customer.name;	// HTML text to display in the InfoWindow
		var infowindow = new google.maps.InfoWindow( { content: contentString } );

		// Set event to display the InfoWindow anchored to the marker when the marker is clicked.
		google.maps.event.addListener( marker, 'click', function() { infowindow.open( map, marker ); });

	}

	function showProspects()
	{
		var filter = {"personType":["Prospect"]};
		filterMap(filter);
	}

	function showProspectsAndCustomers()
	{
		var filter = {"personType":["Prospect","Customer"]};
		filterMap(filter);
	}

	function filterMap(filter)
	{
		filterApplied = filter;
		showAllPoints();
		filterByPersonType(filter.personType);
		//filterByAge(filter.minAge, filter.maxAge);
		//filterByTags(filter.tags);
		rejiggerHeatmap();
	}

	function showAllPoints()
	{
		points.forEach(markPointsShown);
	}

	function filterByPersonType(personType)
	{
		var arrayLength = points.length;
		for (var i = 0; i < arrayLength; i++)
		{
			hideUnmatchedPointsByType(personType, points[i])
		}
	}

	function hideUnmatchedPointsByType(personType, point)
	{
		var arrayLength = personType.length;
		var match = false;
		for (var i = 0; i < arrayLength; i++) {
			if(point.customer.personType.toLowerCase() == personType[i].toLowerCase())
			{
				match = true;
			}
		}
		if(match == false)
		{
			point.shown = false;
			point.marker.setMap(null);
		}
	}

	function filterByAge(minAge, maxAge)
	{
		points.forEach(hideUnmatchedPointsByAge(minAge, maxAge));
	}

	function filterByTags(tags)
	{
		points.forEach(hideUnmatchedPointsByTag(tags));
	}

	function rejiggerHeatmap()
	{
		heatmapData = [];
		points.forEach(addToHeatMapIfShown);
		heatmap.setData(heatmapData);
	}

	function addToHeatMapIfShown(point, index)
	{
		if(point.shown)
		{
			heatmapData.push(point.location);
		}
	}

	function showEverything()
	{
		filterApplied = null;
		showAllPoints();
		heatmap.setData(heatmapData);
	}

	function showPin(point, index)
	{
		if(point.shown)
		{
			point.marker.setMap(map);
		}
	}

	function markPointsShown(point, index)
	{
		point.shown = true;
		heatmapData.push(point.location);
		if(!showHeatMap)
		{
			point.marker.setMap(map);
		}
	}

	function hidePin(point, index)
	{
		point.shown = false;
		point.marker.setMap(null);
	}

	function hideAllMarkers()
	{
		points.forEach(hidePin);
	}
	
	function unshowAllMarkers()
	{
		points.forEach(unshowPin);
	}
	
	
	function unshowPin(point, index)
	{
		point.marker.setMap(null);
	}

	</script>
	<style>
	#map-canvas,
	.off-canvas {
		height: 100vh;
	}
	.off-canvas-content {
		position: relative;
		height: 100vh;
	}
	#canvasToggle {
		position: absolute;
		top: 5em;
		left: 5em;
		transform: rotate(0deg);
		transition: transform 0.2s ease;
	}
	#canvasToggle:hover {
		transform: rotate(360deg);
	}
}
	#fooBar {
		background-color: red;
		height: 100vh;
		width: 100vw;
	}
	</style>
</head>
<body>
	<div class="off-canvas-wrapper">
    <div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>
      <div class="off-canvas position-left" id="offCanvas" data-off-canvas>

        <!-- Close button -->
        <button class="close-button" aria-label="Close menu" type="button" data-close>
          <span aria-hidden="true">&times;</span>
        </button>

        <!-- Menu -->
				<div>
					<button class="button" onclick="showEverything()">Everyone</button>
					<button class="button" onclick="showProspects()">Prospects</button>
					<button class="button" onclick="showProspectsAndCustomers()">Prospects &amp; Customers</button>
				</div>

      </div>

      <div class="off-canvas-content" data-off-canvas-content>
				<!-- Dislay Google map here -->
				<div id='map-canvas'></div>
        <button id="canvasToggle" type="button" class="button" data-toggle="offCanvas">Open Menu</button>
      </div>
    </div>
  </div>
	<script src="https://cdn.jsdelivr.net/foundation/6.2.4/foundation.min.js"></script>
	<script>
		$(document).foundation();
	</script>
</body>
</html>
